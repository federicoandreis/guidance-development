{"title":"Example 6: Ambulance Handover Delays","markdown":{"yaml":{"title":"Example 6: Ambulance Handover Delays","subtitle":"SPC with Trend Analysis and Seasonality","number-sections":false},"headingText":"| echo: false","containsRefs":false,"markdown":"\n\n```{r}\n#| message: false\nlibrary(reticulate)\n```\n\n## Scenario Overview\n\n**Method**: Statistical Process Control (SPC) (@sec-spc-basics)  \n**Complexity**: Medium-High  \n**Time to complete**: 2-3 hours  \n**Status**: âœ… Complete\n\n::: {.callout-note icon=false}\n## ðŸ“– Method Reference\nFor detailed explanation of SPC methodology, control charts with trends, and step-by-step guidance, see @sec-spc-basics.\n:::\n\n---\n\n## ðŸ“‹ Scenario\n\nA hospital trust is monitoring ambulance handover delays (>30 minutes) over 18 months. National guidance states handovers should occur within 15 minutes, with 30 minutes as the maximum acceptable threshold.\n\n**Analytical Question**: Are handover delays increasing over time? Are there special causes requiring investigation?\n\n**Context**: This is operational performance monitoring with clear system pressures. The trust needs to understand whether delays are part of common cause variation or indicate special causes requiring intervention.\n\n---\n\n## ðŸŽ¯ Learning Objectives\n\nBy completing this example, you will learn how to:\n\n1. **Apply SPC to trending data** with increasing baseline\n2. **Identify and handle seasonality** (winter pressures)\n3. **Detect special causes** in the presence of trends\n4. **Distinguish trends from shifts** in process performance\n5. **Use trend rules** in SPC (Rule 5: runs above/below centre)\n6. **Interpret SPC in operational context** (system capacity issues)\n7. **Communicate findings** about deteriorating performance\n8. **Document decisions** about when to recalculate limits\n\n---\n\n## ðŸ“Š Dataset Description\n\n### Synthetic Data: `data/ambulance_handovers.csv`\n\n**18 months** of handover delay data:\n\n| Variable | Description | Type | Notes |\n|----------|-------------|------|-------|\n| `month` | Month number | Integer | 1-18 |\n| `date` | Month start date | Date | Jan 2023 - Jun 2024 |\n| `delays_over_30min` | Number of handovers >30 min | Integer | 100-310 per month |\n\n### Data Characteristics\n\n**Realistic patterns**:\n- Increasing trend (~5 delays/month increase)\n- Winter peaks (Dec-Feb): +40 delays\n- Special causes: IT failure (Month 8), flu outbreak (Month 15)\n- Natural variation throughout\n\n**Data generation**: Synthetic data generated using R (`set.seed(42)` for reproducibility). Both R and Python load the same CSV file, ensuring identical results.\n\n---\n\n## Step 1: Data Preparation\n\n**Purpose**: Load and visualize the time series to understand patterns.\n\n---\n\n### Import Data\n\n::: {.panel-tabset}\n\n### R\n\n```{r ex6-import-r}\n#| message: false\n#| warning: false\n\nlibrary(ggplot2)\n\n# Import handover data\nhandover_data <- read.csv(\"data/ambulance_handovers.csv\", stringsAsFactors = FALSE)\nhandover_data$date <- as.Date(handover_data$date)\n\n# Display data\nprint(handover_data)\n\n# Summary\ncat(\"\\nMean delays:\", round(mean(handover_data$delays_over_30min), 1), \"\\n\")\ncat(\"Range:\", min(handover_data$delays_over_30min), \"to\", max(handover_data$delays_over_30min), \"\\n\")\n```\n\n### Python\n\n```{python ex6-import-py}\nimport pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\nfrom scipy import stats\n\n# Import handover data\nhandover_data = pd.read_csv(\"data/ambulance_handovers.csv\")\nhandover_data['date'] = pd.to_datetime(handover_data['date'])\n\n# Display data\nprint(handover_data)\n\n# Summary\nprint(f\"\\nMean delays: {handover_data['delays_over_30min'].mean():.1f}\")\nprint(f\"Range: {handover_data['delays_over_30min'].min()} to {handover_data['delays_over_30min'].max()}\")\n```\n\n:::\n\n**Initial observations**:\n- 18 months of data\n- Delays range from ~140 to ~310 per month\n- Visual inspection needed to identify patterns\n\n---\n\n## Step 2: Visualize Time Series\n\n**Purpose**: Identify trends, seasonality, and potential special causes.\n\n---\n\n::: {.panel-tabset}\n\n### R\n\n```{r ex6-plot-ts-r}\nggplot(handover_data, aes(x = month, y = delays_over_30min)) +\n  geom_line(color = \"steelblue\", linewidth = 1) +\n  geom_point(size = 3, color = \"steelblue\") +\n  scale_x_continuous(breaks = 1:18) +\n  labs(\n    title = \"Ambulance Handover Delays Over Time\",\n    subtitle = \"Number of handovers >30 minutes per month\",\n    x = \"Month\",\n    y = \"Delays >30 min\"\n  ) +\n  theme_minimal()\n```\n\n### Python\n\n```{python ex6-plot-ts-py}\nplt.figure(figsize=(12, 6))\nplt.plot(handover_data['month'], handover_data['delays_over_30min'], \n         marker='o', linewidth=2, markersize=8, color='steelblue')\nplt.xlabel('Month')\nplt.ylabel('Delays >30 min')\nplt.title('Ambulance Handover Delays Over Time\\nNumber of handovers >30 minutes per month')\nplt.xticks(range(1, 19))\nplt.grid(True, alpha=0.3)\nplt.tight_layout()\nplt.show()\n```\n\n:::\n\n**Observations**:\n- Clear increasing trend over 18 months\n- Peaks visible at months 8 and 15\n- Possible seasonal pattern (winter months)\n- Baseline appears unstable (not suitable for standard SPC)\n\n---\n\n## Step 3: Calculate Control Limits\n\n**Purpose**: Apply SPC despite trending data to identify special causes.\n\n**Note**: With trending data, control limits may not be appropriate for the full series. We calculate them to demonstrate the issue.\n\n---\n\n::: {.panel-tabset}\n\n### R\n\n```{r ex6-calc-limits-r}\n# Calculate centre line (mean)\ncentre_line <- mean(handover_data$delays_over_30min)\n\n# Calculate moving range\nmr <- abs(diff(handover_data$delays_over_30min))\nmean_mr <- mean(mr)\n\n# Calculate control limits\nucl <- centre_line + 2.66 * mean_mr\nlcl <- centre_line - 2.66 * mean_mr\n\ncat(\"Control Limits (full series):\\n\")\ncat(\"  Centre Line:\", round(centre_line, 1), \"\\n\")\ncat(\"  UCL:\", round(ucl, 1), \"\\n\")\ncat(\"  LCL:\", round(lcl, 1), \"\\n\")\n\n# Identify points outside limits\nhandover_data$outside_limits <- handover_data$delays_over_30min > ucl | \n                                 handover_data$delays_over_30min < lcl\n\ncat(\"\\nPoints outside limits:\\n\")\nprint(handover_data[handover_data$outside_limits, c(\"month\", \"date\", \"delays_over_30min\")])\n```\n\n### Python\n\n```{python ex6-calc-limits-py}\n# Calculate centre line\ncentre_line = handover_data['delays_over_30min'].mean()\n\n# Calculate moving range\nmr = handover_data['delays_over_30min'].diff().abs().dropna()\nmean_mr = mr.mean()\n\n# Calculate control limits\nucl = centre_line + 2.66 * mean_mr\nlcl = centre_line - 2.66 * mean_mr\n\nprint(\"Control Limits (full series):\")\nprint(f\"  Centre Line: {centre_line:.1f}\")\nprint(f\"  UCL: {ucl:.1f}\")\nprint(f\"  LCL: {lcl:.1f}\")\n\n# Identify points outside limits\nhandover_data['outside_limits'] = (handover_data['delays_over_30min'] > ucl) | \\\n                                   (handover_data['delays_over_30min'] < lcl)\n\nprint(\"\\nPoints outside limits:\")\nprint(handover_data[handover_data['outside_limits']][['month', 'date', 'delays_over_30min']])\n```\n\n:::\n\n**Finding**: Months 8 and 15 are above UCL - special causes detected.\n\n---\n\n## Step 4: Create SPC Chart\n\n**Purpose**: Visualize data with control limits and special causes.\n\n---\n\n::: {.panel-tabset}\n\n### R\n\n```{r ex6-spc-chart-r}\n#| fig-width: 12\n#| fig-height: 7\n\nggplot(handover_data, aes(x = month, y = delays_over_30min)) +\n  geom_hline(yintercept = centre_line, color = \"blue\", linewidth = 1, linetype = \"solid\") +\n  geom_hline(yintercept = ucl, color = \"red\", linewidth = 1, linetype = \"dashed\") +\n  geom_hline(yintercept = lcl, color = \"red\", linewidth = 1, linetype = \"dashed\") +\n  geom_line(color = \"gray50\", linewidth = 0.5) +\n  geom_point(aes(color = outside_limits), size = 4) +\n  scale_color_manual(values = c(\"FALSE\" = \"steelblue\", \"TRUE\" = \"red\"),\n                     labels = c(\"Within limits\", \"Outside limits\")) +\n  scale_x_continuous(breaks = 1:18) +\n  annotate(\"text\", x = 8, y = handover_data$delays_over_30min[8] + 15, \n           label = \"IT failure\", size = 3) +\n  annotate(\"text\", x = 15, y = handover_data$delays_over_30min[15] + 15, \n           label = \"Flu outbreak\", size = 3) +\n  labs(\n    title = \"SPC Chart: Ambulance Handover Delays\",\n    subtitle = \"Note: Trending data makes standard SPC limits less meaningful\",\n    x = \"Month\",\n    y = \"Delays >30 min\",\n    color = \"Point Status\"\n  ) +\n  theme_minimal() +\n  theme(legend.position = \"bottom\")\n```\n\n### Python\n\n```{python ex6-spc-chart-py}\nplt.figure(figsize=(14, 7))\n\n# Plot centre line and limits\nplt.axhline(y=centre_line, color='blue', linewidth=2, label='Centre Line')\nplt.axhline(y=ucl, color='red', linewidth=2, linestyle='--', label='UCL')\nplt.axhline(y=lcl, color='red', linewidth=2, linestyle='--', label='LCL')\n\n# Plot data\nnormal_points = handover_data[~handover_data['outside_limits']]\nspecial_points = handover_data[handover_data['outside_limits']]\n\nplt.plot(handover_data['month'], handover_data['delays_over_30min'], \n         color='gray', linewidth=1, alpha=0.5)\nplt.scatter(normal_points['month'], normal_points['delays_over_30min'], \n           color='steelblue', s=100, label='Within limits', zorder=3)\nplt.scatter(special_points['month'], special_points['delays_over_30min'], \n           color='red', s=100, label='Outside limits', zorder=3)\n\n# Annotations\nplt.annotate('IT failure', xy=(8, handover_data.loc[7, 'delays_over_30min']), \n            xytext=(8, handover_data.loc[7, 'delays_over_30min'] + 20),\n            ha='center', fontsize=9)\nplt.annotate('Flu outbreak', xy=(15, handover_data.loc[14, 'delays_over_30min']), \n            xytext=(15, handover_data.loc[14, 'delays_over_30min'] + 20),\n            ha='center', fontsize=9)\n\nplt.xlabel('Month')\nplt.ylabel('Delays >30 min')\nplt.title('SPC Chart: Ambulance Handover Delays\\nNote: Trending data makes standard SPC limits less meaningful')\nplt.xticks(range(1, 19))\nplt.legend(loc='upper left')\nplt.grid(True, alpha=0.3)\nplt.tight_layout()\nplt.show()\n```\n\n:::\n\n---\n\n## Step 5: Assess Trend\n\n**Purpose**: Quantify the increasing trend using regression.\n\n---\n\n::: {.panel-tabset}\n\n### R\n\n```{r ex6-trend-r}\n# Linear regression\ntrend_model <- lm(delays_over_30min ~ month, data = handover_data)\nsummary(trend_model)\n\n# Extract trend\nslope <- coef(trend_model)[2]\nintercept <- coef(trend_model)[1]\n\ncat(\"\\nTrend Analysis:\\n\")\ncat(\"  Slope:\", round(slope, 2), \"delays per month\\n\")\ncat(\"  Intercept:\", round(intercept, 1), \"\\n\")\ncat(\"  R-squared:\", round(summary(trend_model)$r.squared, 3), \"\\n\")\n\n# Predict values\nhandover_data$predicted <- predict(trend_model)\n```\n\n### Python\n\n```{python ex6-trend-py}\n# Linear regression\nfrom scipy.stats import linregress\n\nslope, intercept, r_value, p_value, std_err = linregress(\n    handover_data['month'], \n    handover_data['delays_over_30min']\n)\n\nprint(\"\\nTrend Analysis:\")\nprint(f\"  Slope: {slope:.2f} delays per month\")\nprint(f\"  Intercept: {intercept:.1f}\")\nprint(f\"  R-squared: {r_value**2:.3f}\")\nprint(f\"  p-value: {p_value:.4f}\")\n\n# Predict values\nhandover_data['predicted'] = intercept + slope * handover_data['month']\n```\n\n:::\n\n**Finding**: Significant increasing trend of ~5 delays per month (p < 0.001). This confirms the process is not stable.\n\n---\n\n## Step 6: Conclusion and Recommendations\n\n**Statistical Conclusion**:\n- Significant increasing trend in handover delays\n- Two special causes identified (Months 8 and 15)\n- Process is not in statistical control\n- Standard SPC limits not appropriate for trending data\n\n**Operational Interpretation**:\n- System capacity deteriorating over time\n- Winter pressures compound the baseline trend\n- Special causes (IT failure, flu outbreak) create additional spikes\n- Trend suggests systemic issues, not just variation\n\n**Recommendations**:\n\n1. **Immediate actions**:\n   - Investigate root causes of increasing trend\n   - Review capacity planning and staffing levels\n   - Prepare for winter pressures (seasonal peaks)\n\n2. **Monitoring approach**:\n   - Use trend analysis rather than standard SPC\n   - Set target trajectory for improvement\n   - Monitor deviations from expected trend\n   - Recalculate limits if trend stabilizes\n\n3. **System improvements**:\n   - Address underlying capacity constraints\n   - Improve handover processes\n   - Enhance winter resilience planning\n   - Implement early warning systems\n\n**Limitations**:\n- Only 18 months of data (limited for seasonal analysis)\n- Single trust (generalizability unknown)\n- External factors (e.g., regional demand) not captured\n- Trend may not be linear long-term\n\n---\n\n## Summary\n\nThis example demonstrates SPC application to **trending data**, showing:\n\nâœ… **Trend detection** using regression analysis  \nâœ… **Special cause identification** despite trend  \nâœ… **Limitations of standard SPC** with unstable processes  \nâœ… **Operational context** interpretation (capacity issues)  \nâœ… **Alternative monitoring approaches** for trending data\n\n**Key Lesson**: When processes show sustained trends, standard SPC control limits become less meaningful. Focus on trend analysis and investigate root causes of deterioration.\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":false,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":true,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../custom.css"],"toc":true,"toc-depth":3,"number-sections":false,"output-file":"example-06-complete.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.1.251","bibliography":["../references.bib"],"theme":"cosmo","number-depth":2,"title":"Example 6: Ambulance Handover Delays","subtitle":"SPC with Trend Analysis and Seasonality"},"extensions":{"book":{"multiFile":true}}}}}