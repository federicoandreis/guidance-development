{"title":"Example 10: Care Home Staffing Investigation","markdown":{"yaml":{"title":"Example 10: Care Home Staffing Investigation","subtitle":"Outlier Detection and Treatment with Data Quality Issues","number-sections":false},"headingText":"| include: false","containsRefs":false,"markdown":"\n\n```{r}\nlibrary(reticulate)\nuse_python(\"C:/Users/fede/anaconda3/python.exe\", required = TRUE)\n```\n\n## Scenario Overview\n\n**Method**: Outlier Detection and Treatment (@sec-outlier-methods)  \n**Complexity**: Medium  \n**Time to complete**: 2-3 hours  \n**Status**: ‚úÖ Complete\n\n::: {.callout-note icon=false}\n## üìñ Method Reference\nFor detailed explanation of outlier detection methods, treatment strategies, and step-by-step guidance, see @sec-outlier-methods.\n:::\n\n---\n\n## üìã Scenario\n\nYou are a CQC analyst investigating staffing levels at adult social care homes. Recent submissions show some extreme staff-to-resident ratios that warrant investigation. The analysis will support:\n\n- Identifying homes requiring immediate inspection (data errors vs genuine understaffing)\n- Understanding natural variation in staffing models\n- Informing risk-based targeting\n\n**Analytical Question**: Which care homes have staffing ratios extreme enough to warrant investigation, and which extreme values are data errors versus genuine operational issues?\n\n**Context**: Care homes report monthly staffing data. Most homes have 2-4 qualified staff per 10 residents, but you've seen values ranging from 0 to 12. Some may be data entry errors (wrong decimal point, missing zeros), others may reflect genuine operational models (specialist dementia units) or problems (understaffing due to recruitment issues).\n\n---\n\n## üéØ Learning Objectives\n\nBy working through this example, you will learn to:\n\n1. **Visualize data** to understand distribution before detection\n2. **Apply multiple detection methods** (Z-score, Modified Z-score, IQR)\n3. **Compare method results** to prioritize investigation\n4. **Investigate flagged observations** systematically\n5. **Distinguish data errors from genuine extremes**\n6. **Document outlier treatment decisions** for QA purposes\n7. **Communicate findings** to inspection teams\n8. **Handle small provider variation** appropriately\n\n---\n\n## üìä Dataset Description\n\n### Synthetic Data: Generated for this example\n\n**350 care homes** with the following variables:\n\n| Variable | Description | Type | Notes |\n|----------|-------------|------|-------|\n| `home_id` | Unique home identifier | String | Format: CH001-CH350 |\n| `home_name` | Care home name | String | Synthetic names |\n| `region` | NHS England region | String | 7 regions |\n| `beds` | Number of beds | Integer | 15-120 beds |\n| `care_type` | Specialization | String | General, Dementia, Nursing |\n| `cqc_rating` | Current CQC rating | String | Outstanding to Inadequate |\n| `staff_per_10` | Qualified staff per 10 residents | Numeric | Ratio (target 2.5-4.0) |\n\n### Data Characteristics\n\n**Realistic issues included**:\n- Most homes (300): Normal staffing (mean 3.2, SD 0.8)\n- Specialist dementia units (15): Higher staffing (mean 5.5)\n- Struggling homes (10): Low staffing (mean 1.5)\n- Data entry errors (12): Implausible values (0, 0.02, 9.8, 11.2, etc.)\n- Small homes: Higher natural variation\n- Regional differences\n\n---\n\n## üîç Step 1: Load and Explore Data\n\n::: {.panel-tabset}\n## R\n```{r}\n#| eval: true\nset.seed(456)\nsuppressPackageStartupMessages({\n  library(ggplot2)\n})\n# Use base R for data manipulation (no dplyr dependency)\n\n# Generate realistic care home data\nn_normal <- 300\nn_specialist <- 15\nn_struggling <- 10\nn_errors <- 12\nn_total <- n_normal + n_specialist + n_struggling + n_errors\n\ncare_homes <- data.frame(\n  home_id = sprintf(\"CH%03d\", 1:n_total),\n  home_name = paste(\"Care Home\", 1:n_total),\n  region = sample(c(\"London\", \"South East\", \"North West\", \"Midlands\", \n                    \"South West\", \"North East\", \"East\"), n_total, replace = TRUE),\n  beds = sample(15:120, n_total, replace = TRUE),\n  care_type = sample(c(\"General\", \"Dementia\", \"Nursing\"), n_total, \n                     replace = TRUE, prob = c(0.6, 0.2, 0.2)),\n  cqc_rating = sample(c(\"Outstanding\", \"Good\", \"Requires Improvement\", \"Inadequate\"),\n                      n_total, replace = TRUE, prob = c(0.05, 0.7, 0.2, 0.05)),\n  staff_per_10 = c(\n    rnorm(n_normal, mean = 3.2, sd = 0.8),\n    rnorm(n_specialist, mean = 5.5, sd = 0.4),\n    rnorm(n_struggling, mean = 1.5, sd = 0.3),\n    c(0, 0.02, 0.05, 9.8, 10.5, 11.2, -0.3, 0.1, 8.5, 7.9, 6.8, 12.0)\n  )\n)\n\ncare_homes$staff_per_10 <- pmax(care_homes$staff_per_10, 0)\n\nsmall_homes <- care_homes$beds < 30\ncare_homes$staff_per_10[small_homes] <- care_homes$staff_per_10[small_homes] + \n                                        rnorm(sum(small_homes), 0, 0.3)\n\ncat(\"=== CARE HOME STAFFING DATA ===\\n\\n\")\ncat(\"Total homes:\", nrow(care_homes), \"\\n\")\nsummary(care_homes$staff_per_10)\n```\n\n## Python\n```{python}\n#| eval: true\nimport pandas as pd\nimport numpy as np\n\ncare_homes = pd.DataFrame({\n    'home_id': r.care_homes['home_id'],\n    'home_name': r.care_homes['home_name'],\n    'region': r.care_homes['region'],\n    'beds': r.care_homes['beds'],\n    'care_type': r.care_homes['care_type'],\n    'cqc_rating': r.care_homes['cqc_rating'],\n    'staff_per_10': r.care_homes['staff_per_10']\n})\n\nprint(\"=== CARE HOME STAFFING DATA ===\\n\")\nprint(f\"Total homes: {len(care_homes)}\\n\")\nprint(care_homes['staff_per_10'].describe())\n```\n:::\n\n---\n\n## üîç Step 2: Visualize Distribution\n\n::: {.panel-tabset}\n## R\n```{r}\n#| eval: true\n#| fig-width: 14\n#| fig-height: 5\n\nsuppressPackageStartupMessages(library(gridExtra))\n\np1 <- ggplot(care_homes, aes(x = staff_per_10)) +\n  geom_histogram(aes(y = after_stat(density)), bins = 40, \n                 fill = \"lightblue\", alpha = 0.7, color = \"black\") +\n  geom_density(color = \"darkblue\", linewidth = 1.2) +\n  labs(title = \"Distribution of Staffing Ratios\",\n       x = \"Staff per 10 Residents\", y = \"Density\") +\n  theme_minimal()\n\np2 <- ggplot(care_homes, aes(y = staff_per_10)) +\n  geom_boxplot(fill = \"lightblue\", outlier.color = \"red\", outlier.size = 3) +\n  labs(title = \"Box Plot with Outliers\", y = \"Staff per 10 Residents\") +\n  theme_minimal() +\n  theme(axis.text.x = element_blank())\n\ngrid.arrange(p1, p2, ncol = 2)\n```\n\n## Python\n```{python}\n#| eval: true\nimport matplotlib.pyplot as plt\n\nfig, (ax1, ax2) = plt.subplots(1, 2, figsize=(14, 5))\n\nax1.hist(care_homes['staff_per_10'], bins=40, density=True, \n         alpha=0.7, color='lightblue', edgecolor='black')\ncare_homes['staff_per_10'].plot(kind='density', ax=ax1, color='darkblue', linewidth=2)\nax1.set_xlabel('Staff per 10 Residents')\nax1.set_ylabel('Density')\nax1.set_title('Distribution of Staffing Ratios')\n\nax2.boxplot(care_homes['staff_per_10'])\nax2.set_ylabel('Staff per 10 Residents')\nax2.set_title('Box Plot with Outliers')\n\nplt.tight_layout()\nplt.show()\n```\n:::\n\n**Observations**: Right-skewed with extreme values in both tails.\n\n---\n\n## üîç Step 3: Apply Detection Methods\n\n::: {.panel-tabset}\n## R\n```{r}\n#| eval: true\n# Z-score\ncare_homes$z_score <- scale(care_homes$staff_per_10)[,1]\ncare_homes$outlier_z <- abs(care_homes$z_score) > 2.5\n\n# Modified Z-score\nmedian_val <- median(care_homes$staff_per_10)\nmad_val <- mad(care_homes$staff_per_10)\ncare_homes$modified_z <- 0.6745 * (care_homes$staff_per_10 - median_val) / mad_val\ncare_homes$outlier_modz <- abs(care_homes$modified_z) > 3.5\n\n# IQR\nQ1 <- quantile(care_homes$staff_per_10, 0.25)\nQ3 <- quantile(care_homes$staff_per_10, 0.75)\nIQR_val <- IQR(care_homes$staff_per_10)\ncare_homes$outlier_iqr <- care_homes$staff_per_10 < (Q1 - 1.5*IQR_val) | \n                          care_homes$staff_per_10 > (Q3 + 1.5*IQR_val)\n\ncare_homes$num_flags <- care_homes$outlier_z + care_homes$outlier_modz + care_homes$outlier_iqr\n\ncat(\"DETECTION RESULTS:\\n\")\ncat(\"Z-score:\", sum(care_homes$outlier_z), \"outliers\\n\")\ncat(\"Modified Z:\", sum(care_homes$outlier_modz), \"outliers\\n\")\ncat(\"IQR:\", sum(care_homes$outlier_iqr), \"outliers\\n\")\n```\n\n## Python\n```{python}\n#| eval: true\nfrom scipy import stats\nfrom scipy.stats import median_abs_deviation\n\ncare_homes['z_score'] = stats.zscore(care_homes['staff_per_10'])\ncare_homes['outlier_z'] = abs(care_homes['z_score']) > 2.5\n\nmedian_val = care_homes['staff_per_10'].median()\nmad_val = median_abs_deviation(care_homes['staff_per_10'])\ncare_homes['modified_z'] = 0.6745 * (care_homes['staff_per_10'] - median_val) / mad_val\ncare_homes['outlier_modz'] = abs(care_homes['modified_z']) > 3.5\n\nQ1 = care_homes['staff_per_10'].quantile(0.25)\nQ3 = care_homes['staff_per_10'].quantile(0.75)\nIQR_val = Q3 - Q1\ncare_homes['outlier_iqr'] = ((care_homes['staff_per_10'] < Q1 - 1.5*IQR_val) | \n                             (care_homes['staff_per_10'] > Q3 + 1.5*IQR_val))\n\ncare_homes['num_flags'] = (care_homes['outlier_z'].astype(int) + \n                           care_homes['outlier_modz'].astype(int) + \n                           care_homes['outlier_iqr'].astype(int))\n\nprint(\"DETECTION RESULTS:\")\nprint(f\"Z-score: {care_homes['outlier_z'].sum()} outliers\")\nprint(f\"Modified Z: {care_homes['outlier_modz'].sum()} outliers\")\nprint(f\"IQR: {care_homes['outlier_iqr'].sum()} outliers\")\n```\n:::\n\n---\n\n## üîç Step 4: Compare Methods\n\n::: {.panel-tabset}\n## R\n```{r}\n#| eval: true\n# Filter and sort without dplyr\nhigh_priority <- care_homes[care_homes$num_flags >= 2, \n                            c(\"home_id\", \"staff_per_10\", \"z_score\", \"num_flags\", \n                              \"care_type\", \"beds\", \"cqc_rating\")]\nhigh_priority <- high_priority[order(-abs(high_priority$z_score)), ]\n\ncat(\"HIGH PRIORITY (2+ methods):\\n\\n\")\nprint(head(high_priority, 15), row.names = FALSE)\n```\n\n## Python\n```{python}\n#| eval: true\nhigh_priority = care_homes[care_homes['num_flags'] >= 2][\n    ['home_id', 'staff_per_10', 'z_score', 'num_flags', 'care_type', 'beds', 'cqc_rating']\n].sort_values('z_score', key=abs, ascending=False)\n\nprint(\"HIGH PRIORITY (2+ methods):\\n\")\nprint(high_priority.head(15).to_string(index=False))\n```\n:::\n\n---\n\n## üîç Step 5: Investigation and Treatment\n\n::: {.panel-tabset}\n## R\n```{r}\n#| eval: true\n# Base R classification\ninvestigation <- high_priority\ninvestigation$finding <- ifelse(\n  investigation$staff_per_10 < 0.2, \"Data error: Decimal missing\",\n  ifelse(investigation$staff_per_10 > 9, \"Data error: Wrong unit\",\n  ifelse(investigation$care_type == \"Dementia\" & investigation$staff_per_10 > 4.5, \n         \"Genuine: Specialist unit\",\n  ifelse(investigation$staff_per_10 < 1.8 & investigation$cqc_rating == \"Inadequate\",\n         \"Concern: Known issues\",\n  ifelse(investigation$staff_per_10 > 5 & investigation$beds < 30, \n         \"Small home variation\", \"Requires investigation\")))))\n\ninvestigation$action <- ifelse(\n  grepl(\"Data error\", investigation$finding), \"Exclude\",\n  ifelse(grepl(\"Concern\", investigation$finding), \"Flag for inspection\",\n         \"Keep with note\"))\n\ncat(\"INVESTIGATION SUMMARY:\\n\\n\")\ntable(investigation$action)\n```\n\n## Python\n```{python}\n#| eval: true\ndef classify_finding(row):\n    if row['staff_per_10'] < 0.2:\n        return \"Data error: Decimal missing\"\n    elif row['staff_per_10'] > 9:\n        return \"Data error: Wrong unit\"\n    elif row['care_type'] == \"Dementia\" and row['staff_per_10'] > 4.5:\n        return \"Genuine: Specialist unit\"\n    elif row['staff_per_10'] < 1.8 and row['cqc_rating'] == \"Inadequate\":\n        return \"Concern: Known issues\"\n    elif row['staff_per_10'] > 5 and row['beds'] < 30:\n        return \"Small home variation\"\n    return \"Requires investigation\"\n\ndef classify_action(finding):\n    if \"Data error\" in finding:\n        return \"Exclude\"\n    elif \"Concern\" in finding:\n        return \"Flag for inspection\"\n    return \"Keep with note\"\n\ninvestigation = high_priority.copy()\ninvestigation['finding'] = investigation.apply(classify_finding, axis=1)\ninvestigation['action'] = investigation['finding'].apply(classify_action)\n\nprint(\"INVESTIGATION SUMMARY:\\n\")\nprint(investigation['action'].value_counts())\n```\n:::\n\n---\n\n## üìä Final Output\n\n::: {.panel-tabset}\n## R\n```{r}\n#| eval: true\n# Merge investigation results (base R)\ninvest_subset <- investigation[, c(\"home_id\", \"finding\", \"action\")]\ncare_homes_final <- merge(care_homes, invest_subset, by = \"home_id\", all.x = TRUE)\ncare_homes_final$exclude <- !is.na(care_homes_final$action) & \n                            care_homes_final$action == \"Exclude\"\n\ncare_homes_clean <- care_homes_final[is.na(care_homes_final$exclude) | \n                                     !care_homes_final$exclude, ]\n\ncat(\"FINAL SUMMARY:\\n\")\ncat(\"Total homes:\", nrow(care_homes_final), \"\\n\")\ncat(\"Excluded:\", sum(care_homes_final$exclude, na.rm = TRUE), \"\\n\")\ncat(\"Clean dataset:\", nrow(care_homes_clean), \"\\n\")\ncat(\"Mean (clean):\", round(mean(care_homes_clean$staff_per_10), 2), \"\\n\")\n```\n\n## Python\n```{python}\n#| eval: true\ncare_homes_final = care_homes.merge(\n    investigation[['home_id', 'finding', 'action']], on='home_id', how='left'\n)\ncare_homes_final['exclude'] = (care_homes_final['action'] == 'Exclude')\n\ncare_homes_clean = care_homes_final[~care_homes_final['exclude'].fillna(False)]\n\nprint(\"FINAL SUMMARY:\")\nprint(f\"Total homes: {len(care_homes_final)}\")\nprint(f\"Excluded: {care_homes_final['exclude'].sum()}\")\nprint(f\"Clean dataset: {len(care_homes_clean)}\")\nprint(f\"Mean (clean): {care_homes_clean['staff_per_10'].mean():.2f}\")\n```\n:::\n\n---\n\n## üìù Key Takeaways\n\n### What We Learned\n\n1. **Multiple methods essential**: Agreement across methods prioritizes investigation\n2. **Investigation is crucial**: Detection flags candidates, investigation determines action\n3. **Document everything**: Record findings and justifications for QA\n4. **Context matters**: Specialist units and small homes legitimately differ\n5. **Data quality**: Many \"outliers\" were simply data entry errors\n\n### Recommendations for Inspection Team\n\n**Immediate action required**:\n- Homes flagged with genuine staffing concerns\n- Data quality issues to be corrected by providers\n\n**Monitor**:\n- Small homes with higher variation (natural)\n- Specialist units with elevated staffing (expected)\n\n### QA Documentation\n\nComplete investigation log created including:\n- Detection method results\n- Investigation findings for each flagged home\n- Treatment decisions with justification\n- Final clean dataset with exclusion flags\n\n---\n\n## üí° Practical Tips\n\n1. **Always visualize first**: Understand distribution before applying methods\n2. **Use multiple methods**: Look for consensus, not single-method results\n3. **Prioritize investigation**: Focus on homes flagged by 2+ methods\n4. **Contact providers**: Many \"outliers\" are simple data entry errors\n5. **Consider context**: Small providers and specialists naturally vary\n6. **Document thoroughly**: Investigation log essential for QA and defensibility\n\n---\n\n## üîó Related Resources\n\n- **Chapter 15**: Outlier Detection and Treatment (@sec-outlier-methods)\n- **Chapter 7**: Unusual Observations (conceptual foundations) (@sec-unusual-observations)\n- **Chapter 10**: QA Principles (@sec-qa-principles)\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":false,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":true,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../custom.css"],"toc":true,"toc-depth":3,"number-sections":false,"output-file":"example-10-outliers.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.1.251","bibliography":["../references.bib"],"theme":"cosmo","number-depth":2,"title":"Example 10: Care Home Staffing Investigation","subtitle":"Outlier Detection and Treatment with Data Quality Issues"},"extensions":{"book":{"multiFile":true}}}}}