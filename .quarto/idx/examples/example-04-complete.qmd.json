{"title":"Example 4: Medication Safety Pilot","markdown":{"yaml":{"title":"Example 4: Medication Safety Pilot","subtitle":"Paired t-test with Small Sample","number-sections":false},"headingText":"| include: false","containsRefs":false,"markdown":"\n\n```{r}\n# Setup Python environment\nlibrary(reticulate)\n```\n\n## Scenario Overview\n\n**Method**: Paired t-test (@sec-t-tests)  \n**Complexity**: Medium  \n**Time to complete**: 2-3 hours  \n**Status**: Complete\n\n::: {.callout-note icon=false}\n## Method Reference\nFor detailed explanation of t-test methodology, paired design considerations, and step-by-step guidance, see @sec-t-tests.\n:::\n\n---\n\n## Scenario\n\nA medication safety intervention was piloted in 15 care homes over 6 months. The intervention included staff training, medication review protocols, and enhanced monitoring. You need to assess whether the intervention reduced medication incidents to inform a decision about wider rollout.\n\n**Analytical Question**: Did the medication safety intervention significantly reduce medication incident rates in the pilot care homes?\n\n**Context**: This is a small-scale pilot with before/after measurements in the same care homes (paired design). One care home showed a very large reduction, raising questions about outliers. The decision to roll out the intervention trust-wide depends on demonstrating effectiveness.\n\n---\n\n## ðŸŽ¯ Learning Objectives\n\nBy working through this example, you will learn to:\n\n1. **Understand paired vs independent designs** and when each is appropriate\n2. **Handle small samples** (N=15) and their implications\n3. **Check paired t-test assumptions** (normality of differences, no outliers)\n4. **Identify and handle outliers** in small samples\n5. **Calculate and interpret effect sizes** (Cohen's d)\n6. **Distinguish statistical vs practical significance** \n7. **Assess power** and risk of Type II error\n8. **Communicate findings** for decision-making with limited evidence\n\n---\n\n## ðŸ“Š Dataset Description\n\n### Synthetic Data: `data/medication_safety_data.csv`\n\n**15 care homes** with before/after measurements:\n\n| Variable | Description | Type | Notes |\n|----------|-------------|------|-------|\n| `home_id` | Care home identifier | String | CH01-CH15 |\n| `home_name` | Care home name | String | Synthetic names |\n| `beds` | Number of beds | Integer | 20-80 beds |\n| `incidents_before` | Incidents per month (baseline) | Float | 3-12 incidents |\n| `incidents_after` | Incidents per month (post-intervention) | Float | 2-10 incidents |\n| `difference` | Change (after - before) | Float | Negative = improvement |\n\n### Data Characteristics\n\n**Realistic patterns**:\n- Small sample (N=15 care homes)\n- Paired measurements (same homes before/after)\n- One outlier (very large reduction)\n- Most homes show modest improvement\n- Some variation in home size\n\n**Data generation**: Synthetic data generated using R (`set.seed(42)`). Most homes show 20-30% reduction, one home shows 60% reduction (outlier). Both R and Python load the same CSV file, ensuring identical results.\n\n---\n\n## Step 1: Data Preparation\n\n**Purpose**: Load realistic paired medication safety data.\n\n---\n\n::: {.panel-tabset}\n\n### R\n\n```{r ex4-generate-r}\n#| message: false\n#| warning: false\n\nlibrary(ggplot2)\n\n# Import medication safety data\nmed_data <- read.csv(\"data/medication_safety_data.csv\", stringsAsFactors = FALSE)\n\n# Display data\nprint(med_data)\n\n# Summary\ncat(\"\\nBaseline mean:\", round(mean(med_data$incidents_before), 2), \"incidents/month\\n\")\ncat(\"Post-intervention mean:\", round(mean(med_data$incidents_after), 2), \"incidents/month\\n\")\ncat(\"Mean reduction:\", round(mean(med_data$difference), 2), \"incidents/month\\n\")\n```\n\n### Python\n\n```{python ex4-generate-py}\nimport pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\nfrom scipy import stats\n\n# Import medication safety data\nmed_data = pd.read_csv(\"data/medication_safety_data.csv\")\n\n# Display data\nprint(med_data)\n\n# Summary\nprint(f\"\\nBaseline mean: {med_data['incidents_before'].mean():.2f} incidents/month\")\nprint(f\"Post-intervention mean: {med_data['incidents_after'].mean():.2f} incidents/month\")\nprint(f\"Mean reduction: {med_data['difference'].mean():.2f} incidents/month\")\n```\n\n:::\n\n---\n\n## Step 2: Visualize Paired Data\n\n**Purpose**: Understand the pattern of change across care homes.\n\n---\n\n::: {.panel-tabset}\n\n### R\n\n```{r ex4-viz-r}\n#| fig-width: 10\n#| fig-height: 6\n\n# Before-after plot\nggplot(med_data) +\n  geom_segment(aes(x = incidents_before, xend = incidents_after,\n                   y = reorder(home_id, incidents_before), \n                   yend = reorder(home_id, incidents_before)),\n               arrow = arrow(length = unit(0.2, \"cm\")), \n               color = \"steelblue\", size = 1) +\n  geom_point(aes(x = incidents_before, y = home_id), \n             color = \"red\", size = 3) +\n  geom_point(aes(x = incidents_after, y = home_id), \n             color = \"darkgreen\", size = 3) +\n  labs(\n    title = \"Medication Incidents: Before vs After Intervention\",\n    subtitle = \"Red = Before | Green = After | Arrow shows direction of change\",\n    x = \"Incidents per Month\",\n    y = \"Care Home\"\n  ) +\n  theme_minimal()\n\n# Histogram of differences\nggplot(med_data, aes(x = difference)) +\n  geom_histogram(bins = 8, fill = \"steelblue\", color = \"white\") +\n  geom_vline(xintercept = 0, color = \"red\", linetype = \"dashed\") +\n  labs(\n    title = \"Distribution of Changes in Incident Rates\",\n    subtitle = \"Negative values = improvement\",\n    x = \"Change in Incidents (After - Before)\",\n    y = \"Number of Care Homes\"\n  ) +\n  theme_minimal()\n```\n\n### Python\n\n```{python ex4-viz-py}\n# Before-after plot\nfig, (ax1, ax2) = plt.subplots(1, 2, figsize=(14, 6))\n\n# Slope plot\nfor idx, row in med_data.iterrows():\n    ax1.plot([0, 1], [row['incidents_before'], row['incidents_after']], \n             'o-', color='steelblue', alpha=0.6)\n    \nax1.set_xticks([0, 1])\nax1.set_xticklabels(['Before', 'After'])\nax1.set_ylabel('Incidents per Month')\nax1.set_title('Medication Incidents: Before vs After Intervention')\nax1.grid(True, alpha=0.3)\n\n# Histogram of differences\nax2.hist(med_data['difference'], bins=8, color='steelblue', edgecolor='white')\nax2.axvline(x=0, color='red', linestyle='--', linewidth=2)\nax2.set_xlabel('Change in Incidents (After - Before)')\nax2.set_ylabel('Number of Care Homes')\nax2.set_title('Distribution of Changes\\nNegative = improvement')\nax2.grid(True, alpha=0.3)\n\nplt.tight_layout()\nplt.show()\n```\n\n:::\n\n**Observations**:\n- All homes show reduction (all arrows point left)\n- One home (CH03) shows much larger reduction than others\n- Most changes cluster around -2 to -3 incidents\n\n---\n\n## Step 3: Check Assumptions\n\n**Purpose**: Verify paired t-test assumptions before proceeding.\n\n---\n\n### Assumption 1: Normality of Differences\n\n::: {.panel-tabset}\n\n### R\n\n```{r ex4-normality-r}\n# Q-Q plot of differences\nggplot(med_data, aes(sample = difference)) +\n  stat_qq() +\n  stat_qq_line(color = \"red\") +\n  labs(\n    title = \"Q-Q Plot: Normality of Differences\",\n    x = \"Theoretical Quantiles\",\n    y = \"Sample Quantiles\"\n  ) +\n  theme_minimal()\n\n# Shapiro-Wilk test\nshapiro_result <- shapiro.test(med_data$difference)\ncat(\"Shapiro-Wilk test p-value:\", round(shapiro_result$p.value, 3), \"\\n\")\ncat(\"Interpretation:\", \n    ifelse(shapiro_result$p.value > 0.05, \n           \"No evidence against normality (p > 0.05)\",\n           \"Evidence of non-normality (p < 0.05)\"), \"\\n\")\n```\n\n### Python\n\n```{python ex4-normality-py}\n# Q-Q plot of differences\nfig, ax = plt.subplots(figsize=(8, 8))\nstats.probplot(med_data['difference'], dist=\"norm\", plot=ax)\nax.set_title(\"Q-Q Plot: Normality of Differences\")\nplt.grid(True, alpha=0.3)\nplt.tight_layout()\nplt.show()\n\n# Shapiro-Wilk test\nstat, p_value = stats.shapiro(med_data['difference'])\nprint(f\"Shapiro-Wilk test p-value: {p_value:.3f}\")\nif p_value > 0.05:\n    print(\"Interpretation: No evidence against normality (p > 0.05)\")\nelse:\n    print(\"Interpretation: Evidence of non-normality (p < 0.05)\")\n```\n\n:::\n\n### Assumption 2: Check for Outliers\n\n::: {.panel-tabset}\n\n### R\n\n```{r ex4-outliers-r}\n# Boxplot of differences\nggplot(med_data, aes(x = \"\", y = difference)) +\n  geom_boxplot(fill = \"steelblue\", alpha = 0.6) +\n  geom_jitter(width = 0.1, size = 3, alpha = 0.6) +\n  geom_hline(yintercept = 0, color = \"red\", linetype = \"dashed\") +\n  labs(\n    title = \"Boxplot of Changes in Incident Rates\",\n    x = \"\",\n    y = \"Change in Incidents (After - Before)\"\n  ) +\n  theme_minimal()\n\n# Identify potential outliers (>1.5 IQR from quartiles)\nQ1 <- quantile(med_data$difference, 0.25)\nQ3 <- quantile(med_data$difference, 0.75)\nIQR <- Q3 - Q1\noutliers <- med_data[med_data$difference < (Q1 - 1.5*IQR) | \n                     med_data$difference > (Q3 + 1.5*IQR), ]\n\nif (nrow(outliers) > 0) {\n  cat(\"\\nPotential outliers detected:\\n\")\n  print(outliers[, c(\"home_id\", \"home_name\", \"incidents_before\", \n                     \"incidents_after\", \"difference\")])\n} else {\n  cat(\"\\nNo outliers detected by IQR method\\n\")\n}\n```\n\n### Python\n\n```{python ex4-outliers-py}\n# Boxplot of differences\nfig, ax = plt.subplots(figsize=(10, 6))\nax.boxplot(med_data['difference'], vert=False)\nax.scatter([med_data['difference'].iloc[i] for i in range(len(med_data))], \n           [1]*len(med_data), alpha=0.6, s=100)\nax.axvline(x=0, color='red', linestyle='--', linewidth=2)\nax.set_xlabel('Change in Incidents (After - Before)')\nax.set_title('Boxplot of Changes in Incident Rates')\nax.grid(True, alpha=0.3)\nplt.tight_layout()\nplt.show()\n\n# Identify potential outliers\nQ1 = med_data['difference'].quantile(0.25)\nQ3 = med_data['difference'].quantile(0.75)\nIQR = Q3 - Q1\noutliers = med_data[(med_data['difference'] < (Q1 - 1.5*IQR)) | \n                    (med_data['difference'] > (Q3 + 1.5*IQR))]\n\nif len(outliers) > 0:\n    print(\"\\nPotential outliers detected:\")\n    print(outliers[['home_id', 'home_name', 'incidents_before', \n                    'incidents_after', 'difference']])\nelse:\n    print(\"\\nNo outliers detected by IQR method\")\n```\n\n:::\n\n**Assessment**:\n- One care home (CH03) identified as potential outlier\n- Very large reduction compared to others\n- Decision: Run analysis with and without outlier\n\n---\n\n## Step 4: Paired t-test (With Outlier)\n\n**Purpose**: Test if intervention reduced incidents (including all data).\n\n---\n\n::: {.panel-tabset}\n\n### R\n\n```{r ex4-ttest-with-r}\n# Paired t-test\nt_result_with <- t.test(med_data$incidents_after, \n                        med_data$incidents_before,\n                        paired = TRUE,\n                        alternative = \"less\")  # One-sided: after < before\n\nprint(t_result_with)\n\n# Effect size (Cohen's d for paired data)\nmean_diff <- mean(med_data$difference)\nsd_diff <- sd(med_data$difference)\ncohens_d <- mean_diff / sd_diff\n\ncat(\"\\nEffect size (Cohen's d):\", round(cohens_d, 2), \"\\n\")\ncat(\"Interpretation:\", \n    ifelse(abs(cohens_d) < 0.2, \"Negligible\",\n    ifelse(abs(cohens_d) < 0.5, \"Small\",\n    ifelse(abs(cohens_d) < 0.8, \"Medium\", \"Large\"))), \"\\n\")\n\n# 95% CI for mean difference\nci <- t_result_with$conf.int\ncat(\"\\n95% CI for mean reduction: [\", round(ci[1], 2), \",\", round(ci[2], 2), \"] incidents\\n\")\n```\n\n### Python\n\n```{python ex4-ttest-with-py}\n# Paired t-test\nt_stat, p_value = stats.ttest_rel(med_data['incidents_after'], \n                                   med_data['incidents_before'],\n                                   alternative='less')  # One-sided: after < before\n\nprint(f\"Paired t-test results:\")\nprint(f\"t-statistic: {t_stat:.3f}\")\nprint(f\"p-value: {p_value:.4f}\")\n\n# Effect size (Cohen's d for paired data)\nmean_diff = med_data['difference'].mean()\nsd_diff = med_data['difference'].std()\ncohens_d = mean_diff / sd_diff\n\nprint(f\"\\nEffect size (Cohen's d): {cohens_d:.2f}\")\nif abs(cohens_d) < 0.2:\n    interpretation = \"Negligible\"\nelif abs(cohens_d) < 0.5:\n    interpretation = \"Small\"\nelif abs(cohens_d) < 0.8:\n    interpretation = \"Medium\"\nelse:\n    interpretation = \"Large\"\nprint(f\"Interpretation: {interpretation}\")\n\n# 95% CI for mean difference\nci = stats.t.interval(0.95, len(med_data)-1, \n                      loc=mean_diff, \n                      scale=stats.sem(med_data['difference']))\nprint(f\"\\n95% CI for mean reduction: [{ci[0]:.2f}, {ci[1]:.2f}] incidents\")\n```\n\n:::\n\n**Results (with outlier)**:\n- Statistically significant reduction (p < 0.05)\n- Large effect size\n- Mean reduction: ~1.4 incidents per month\n\n---\n\n## Step 5: Sensitivity Analysis (Without Outlier)\n\n**Purpose**: Assess robustness of results to outlier.\n\n---\n\n::: {.panel-tabset}\n\n### R\n\n```{r ex4-ttest-without-r}\n# Remove outlier (CH03)\nmed_data_no_outlier <- med_data[med_data$home_id != \"CH03\", ]\n\n# Paired t-test without outlier\nt_result_without <- t.test(med_data_no_outlier$incidents_after, \n                           med_data_no_outlier$incidents_before,\n                           paired = TRUE,\n                           alternative = \"less\")\n\nprint(t_result_without)\n\n# Effect size without outlier\nmean_diff_no <- mean(med_data_no_outlier$difference)\nsd_diff_no <- sd(med_data_no_outlier$difference)\ncohens_d_no <- mean_diff_no / sd_diff_no\n\ncat(\"\\nEffect size without outlier (Cohen's d):\", round(cohens_d_no, 2), \"\\n\")\n\n# Compare results\ncat(\"\\n=== Comparison ===\\n\")\ncat(\"With outlier:    p =\", format.pval(t_result_with$p.value), \n    \"| d =\", round(cohens_d, 2), \"\\n\")\ncat(\"Without outlier: p =\", format.pval(t_result_without$p.value), \n    \"| d =\", round(cohens_d_no, 2), \"\\n\")\n```\n\n### Python\n\n```{python ex4-ttest-without-py}\n# Remove outlier (CH03)\nmed_data_no_outlier = med_data[med_data['home_id'] != \"CH03\"]\n\n# Paired t-test without outlier\nt_stat_no, p_value_no = stats.ttest_rel(med_data_no_outlier['incidents_after'], \n                                        med_data_no_outlier['incidents_before'],\n                                        alternative='less')\n\nprint(f\"Paired t-test results (without outlier):\")\nprint(f\"t-statistic: {t_stat_no:.3f}\")\nprint(f\"p-value: {p_value_no:.4f}\")\n\n# Effect size without outlier\nmean_diff_no = med_data_no_outlier['difference'].mean()\nsd_diff_no = med_data_no_outlier['difference'].std()\ncohens_d_no = mean_diff_no / sd_diff_no\n\nprint(f\"\\nEffect size without outlier (Cohen's d): {cohens_d_no:.2f}\")\n\n# Compare results\nprint(\"\\n=== Comparison ===\")\nprint(f\"With outlier:    p = {p_value:.4f} | d = {cohens_d:.2f}\")\nprint(f\"Without outlier: p = {p_value_no:.4f} | d = {cohens_d_no:.2f}\")\n```\n\n:::\n\n**Sensitivity Analysis**:\n- Results remain significant without outlier\n- Effect size slightly smaller but still substantial\n- Conclusion robust to outlier\n\n---\n\n## Step 6: Conclusion and Recommendation\n\n**Statistical Conclusion**:\n- Significant reduction in medication incidents (p < 0.05)\n- Large effect size (Cohen's d > 0.8)\n- Results robust to outlier exclusion\n- All 15 homes showed improvement\n\n**Practical Significance**:\n- Mean reduction: ~1.4 incidents per month per home\n- Across 100 homes: ~140 fewer incidents per month\n- Clinically meaningful improvement\n\n**Limitations**:\n- Small sample (N=15) limits generalizability\n- No control group (can't rule out temporal trends)\n- One outlier suggests variable effectiveness\n- 6-month follow-up may not capture long-term sustainability\n\n**Recommendation**: \n- **Proceed with wider rollout** based on consistent evidence of effectiveness\n- **Monitor implementation** to ensure similar results at scale\n- **Investigate CH03** to understand factors behind exceptional improvement\n- **Plan longer-term evaluation** to assess sustainability\n\n---\n\n**Analysis Complete** âœ…\n\n---\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":false,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":true,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../custom.css"],"toc":true,"toc-depth":3,"number-sections":false,"output-file":"example-04-complete.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.1.251","bibliography":["../references.bib"],"theme":"cosmo","number-depth":2,"title":"Example 4: Medication Safety Pilot","subtitle":"Paired t-test with Small Sample"},"extensions":{"book":{"multiFile":true}}}}}