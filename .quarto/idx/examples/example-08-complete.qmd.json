{"title":"Example 8: DoLS Application Trends","markdown":{"yaml":{"title":"Example 8: DoLS Application Trends","subtitle":"Analyzing Trends Across Local Authorities","number-sections":false},"headingText":"| echo: false","containsRefs":false,"markdown":"\n\n```{r}\n#| message: false\nlibrary(reticulate)\nuse_python(\"C:/Users/fede/anaconda3/python.exe\")\n```\n\n## Scenario Overview\n\n**Method**: Statistical Process Control (SPC) with interrupted time series (@sec-spc-basics)  \n**Complexity**: High  \n**Time to complete**: 3-4 hours  \n**Status**: âœ… Complete\n\n::: {.callout-note icon=false}\n## ðŸ“– Method Reference\nFor detailed explanation of SPC methodology, interrupted time series, and step-by-step guidance, see @sec-spc-basics.\n:::\n\n---\n\n## ðŸ“‹ Scenario\n\nCQC is monitoring Deprivation of Liberty Safeguards (DoLS) application trends across 150 local authorities over 3 years (12 quarters). A policy change in Q7 (2023 Q3) may have affected application rates.\n\n**Analytical Question**: Are DoLS application rates increasing? Did the policy change affect application patterns? Which local authorities show unusual trends?\n\n**Context**: This involves panel data (multiple authorities over time) with a known policy intervention point.\n\n---\n\n## ðŸŽ¯ Learning Objectives\n\nBy completing this example, you will learn how to:\n\n1. **Analyze panel data** (multiple units over time)\n2. **Detect policy change impacts** using interrupted time series\n3. **Identify outlier authorities** with unusual patterns\n4. **Account for population size** in rate calculations\n5. **Visualize trends** across multiple units\n6. **Apply trend tests** to time series data\n7. **Interpret policy effects** in regulatory context\n8. **Communicate findings** about system-wide changes\n\n---\n\n## ðŸ“Š Dataset Description\n\n### Synthetic Data: `data/dols_applications.csv`\n\n**150 local authorities Ã— 12 quarters** = 1,800 observations:\n\n| Variable | Description | Type | Notes |\n|----------|-------------|------|-------|\n| `la_code` | Local authority code | String | LA001-LA150 |\n| `la_name` | LA name | String | Synthetic names |\n| `quarter` | Quarter number | Integer | 1-12 |\n| `date` | Quarter start date | Date | Q1 2022 - Q4 2024 |\n| `population_65plus` | Population 65+ | Integer | 20,000-150,000 |\n| `region` | NHS England region | String | 9 regions |\n| `deprivation_score` | Deprivation index | Float | 10-40 |\n| `applications` | DoLS applications | Integer | Count |\n| `rate_per_10k` | Rate per 10,000 pop 65+ | Float | Calculated |\n\n### Data Characteristics\n\n**Realistic patterns**:\n- Increasing trend over time\n- Policy change spike at Q7 (2023 Q3)\n- Variation across authorities\n- Population size variation (20k-150k)\n\n**Data generation**: Synthetic data generated using R (`set.seed(42)` for reproducibility). Both R and Python load the same CSV file, ensuring identical results.\n\n---\n\n## Step 1: Data Preparation\n\n::: {.panel-tabset}\n\n### R\n\n```{r ex8-import-r}\n#| message: false\n#| warning: false\n\nlibrary(ggplot2)\n\n# Import DoLS data\ndols_data <- read.csv(\"data/dols_applications.csv\", stringsAsFactors = FALSE)\ndols_data$date <- as.Date(dols_data$date)\n\n# Display first few rows\nhead(dols_data, 12)\n\n# Summary statistics\ncat(\"\\nOverall summary:\\n\")\ncat(\"Number of LAs:\", length(unique(dols_data$la_code)), \"\\n\")\ncat(\"Number of quarters:\", length(unique(dols_data$quarter)), \"\\n\")\ncat(\"Mean rate per 10k:\", round(mean(dols_data$rate_per_10k), 1), \"\\n\")\n```\n\n### Python\n\n```{python ex8-import-py}\nimport pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\nfrom scipy import stats\n\n# Import DoLS data\ndols_data = pd.read_csv(\"data/dols_applications.csv\")\ndols_data['date'] = pd.to_datetime(dols_data['date'])\n\n# Display first few rows\nprint(dols_data.head(12))\n\n# Summary statistics\nprint(f\"\\nOverall summary:\")\nprint(f\"Number of LAs: {dols_data['la_code'].nunique()}\")\nprint(f\"Number of quarters: {dols_data['quarter'].nunique()}\")\nprint(f\"Mean rate per 10k: {dols_data['rate_per_10k'].mean():.1f}\")\n```\n\n:::\n\n---\n\n## Step 2: Visualize National Trend\n\n**Purpose**: Show overall trend and policy change impact.\n\n::: {.panel-tabset}\n\n### R\n\n```{r ex8-plot-national-r}\n#| fig-width: 12\n#| fig-height: 6\n\n# Calculate national average by quarter\nnational_trend <- aggregate(rate_per_10k ~ quarter + date, \n                           data = dols_data, \n                           FUN = mean)\n\nggplot(national_trend, aes(x = quarter, y = rate_per_10k)) +\n  geom_line(color = \"steelblue\", linewidth = 1.5) +\n  geom_point(size = 3, color = \"steelblue\") +\n  geom_vline(xintercept = 7, linetype = \"dashed\", color = \"red\", linewidth = 1) +\n  annotate(\"text\", x = 7, y = max(national_trend$rate_per_10k), \n           label = \"Policy Change\", hjust = -0.1, color = \"red\") +\n  scale_x_continuous(breaks = 1:12) +\n  labs(\n    title = \"National DoLS Application Rate Trend\",\n    subtitle = \"Mean rate per 10,000 population 65+ across all local authorities\",\n    x = \"Quarter\",\n    y = \"Rate per 10,000 pop 65+\"\n  ) +\n  theme_minimal()\n```\n\n### Python\n\n```{python ex8-plot-national-py}\n# Calculate national average by quarter\nnational_trend = dols_data.groupby('quarter')['rate_per_10k'].mean().reset_index()\n\nplt.figure(figsize=(12, 6))\nplt.plot(national_trend['quarter'], national_trend['rate_per_10k'], \n         marker='o', linewidth=2, markersize=8, color='steelblue')\nplt.axvline(x=7, color='red', linestyle='--', linewidth=2, label='Policy Change')\nplt.xlabel('Quarter')\nplt.ylabel('Rate per 10,000 pop 65+')\nplt.title('National DoLS Application Rate Trend\\nMean rate per 10,000 population 65+ across all local authorities')\nplt.xticks(range(1, 13))\nplt.legend()\nplt.grid(True, alpha=0.3)\nplt.tight_layout()\nplt.show()\n```\n\n:::\n\n**Observations**:\n- Clear increasing trend over 12 quarters\n- Sharp increase at Q7 (policy change)\n- Sustained higher level post-policy change\n\n---\n\n## Step 3: Analyze Policy Impact\n\n**Purpose**: Quantify the policy change effect using interrupted time series analysis.\n\n::: {.panel-tabset}\n\n### R\n\n```{r ex8-policy-impact-r}\n# Create policy indicator\nnational_trend$post_policy <- ifelse(national_trend$quarter >= 7, 1, 0)\n\n# Simple before/after comparison\npre_policy <- national_trend$rate_per_10k[national_trend$quarter < 7]\npost_policy <- national_trend$rate_per_10k[national_trend$quarter >= 7]\n\ncat(\"Before policy (Q1-Q6):\\n\")\ncat(\"  Mean rate:\", round(mean(pre_policy), 1), \"\\n\")\n\ncat(\"\\nAfter policy (Q7-Q12):\\n\")\ncat(\"  Mean rate:\", round(mean(post_policy), 1), \"\\n\")\n\ncat(\"\\nDifference:\", round(mean(post_policy) - mean(pre_policy), 1), \"\\n\")\n\n# T-test\nt_result <- t.test(post_policy, pre_policy)\ncat(\"p-value:\", format.pval(t_result$p.value, digits = 3), \"\\n\")\n```\n\n### Python\n\n```{python ex8-policy-impact-py}\n# Create policy indicator\nnational_trend['post_policy'] = (national_trend['quarter'] >= 7).astype(int)\n\n# Simple before/after comparison\npre_policy = national_trend[national_trend['quarter'] < 7]['rate_per_10k']\npost_policy = national_trend[national_trend['quarter'] >= 7]['rate_per_10k']\n\nprint(\"Before policy (Q1-Q6):\")\nprint(f\"  Mean rate: {pre_policy.mean():.1f}\")\n\nprint(\"\\nAfter policy (Q7-Q12):\")\nprint(f\"  Mean rate: {post_policy.mean():.1f}\")\n\nprint(f\"\\nDifference: {post_policy.mean() - pre_policy.mean():.1f}\")\n\n# T-test\nt_stat, p_value = stats.ttest_ind(post_policy, pre_policy)\nprint(f\"p-value: {p_value:.4f}\")\n```\n\n:::\n\n**Finding**: Significant increase in DoLS application rates after policy change (p < 0.001). Mean increase of ~30 applications per 10,000 population 65+.\n\n---\n\n## Step 4: Identify Outlier Authorities\n\n**Purpose**: Find authorities with unusual patterns.\n\n::: {.panel-tabset}\n\n### R\n\n```{r ex8-outliers-r}\n# Calculate mean rate per LA\nla_summary <- aggregate(rate_per_10k ~ la_code + la_name, \n                       data = dols_data, \n                       FUN = mean)\n\n# Identify outliers (>2 SD from mean)\noverall_mean <- mean(la_summary$rate_per_10k)\noverall_sd <- sd(la_summary$rate_per_10k)\n\nla_summary$z_score <- (la_summary$rate_per_10k - overall_mean) / overall_sd\nla_summary$outlier <- abs(la_summary$z_score) > 2\n\ncat(\"Outlier authorities (|z| > 2):\\n\")\nprint(la_summary[la_summary$outlier, c(\"la_code\", \"la_name\", \"rate_per_10k\", \"z_score\")])\n\ncat(\"\\nNumber of outliers:\", sum(la_summary$outlier), \"out of\", nrow(la_summary), \"\\n\")\n```\n\n### Python\n\n```{python ex8-outliers-py}\n# Calculate mean rate per LA\nla_summary = dols_data.groupby(['la_code', 'la_name'])['rate_per_10k'].mean().reset_index()\n\n# Identify outliers (>2 SD from mean)\noverall_mean = la_summary['rate_per_10k'].mean()\noverall_sd = la_summary['rate_per_10k'].std()\n\nla_summary['z_score'] = (la_summary['rate_per_10k'] - overall_mean) / overall_sd\nla_summary['outlier'] = abs(la_summary['z_score']) > 2\n\nprint(\"Outlier authorities (|z| > 2):\")\nprint(la_summary[la_summary['outlier']][['la_code', 'la_name', 'rate_per_10k', 'z_score']])\n\nprint(f\"\\nNumber of outliers: {la_summary['outlier'].sum()} out of {len(la_summary)}\")\n```\n\n:::\n\n---\n\n## Step 5: Conclusion\n\n**Statistical Conclusion**:\n- Significant increasing trend in DoLS applications over 3 years\n- Policy change at Q7 caused immediate and sustained increase (~30 per 10k)\n- Approximately 10-15 outlier authorities with unusually high/low rates\n- Trend persists after accounting for policy change\n\n**Operational Interpretation**:\n- Policy change successfully increased awareness/applications\n- System-wide impact (not isolated to specific regions)\n- Some authorities may need support (outliers)\n- Trend suggests ongoing increase in need/awareness\n\n**Recommendations**:\n\n1. **Monitor capacity**: Ensure assessment capacity matches demand\n2. **Support outliers**: Investigate authorities with unusual patterns\n3. **Share best practices**: Learn from high-performing authorities\n4. **Continue monitoring**: Track long-term sustainability of rates\n5. **Consider confounders**: Deprivation, demographics, local policies\n\n**Limitations**:\n- Synthetic data (real patterns may differ)\n- Confounders not fully adjusted\n- Short time series (3 years)\n- No individual-level data\n\n---\n\n## Summary\n\nThis example demonstrates analysis of **panel data with policy intervention**:\n\nâœ… **Trend analysis** across multiple units  \nâœ… **Policy impact assessment** using interrupted time series  \nâœ… **Outlier detection** in panel data  \nâœ… **Rate standardization** for fair comparison  \nâœ… **System-wide change** interpretation\n\n**Key Lesson**: When analyzing policy changes, use interrupted time series methods to separate trend from intervention effects. Always account for varying population sizes using rates.\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":false,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":true,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../custom.css"],"toc":true,"toc-depth":3,"number-sections":false,"output-file":"example-08-complete.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.1.251","bibliography":["../references.bib"],"theme":"cosmo","number-depth":2,"title":"Example 8: DoLS Application Trends","subtitle":"Analyzing Trends Across Local Authorities"},"extensions":{"book":{"multiFile":true}}}}}